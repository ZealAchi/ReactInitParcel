import { from, empty, of, defer } from 'rxjs';
import { catchError, map, concatAll, filter, takeWhile } from 'rxjs/operators';
import { isFieldSetModel } from './models';
import { finalizeWithLast } from './finalize-with-last';
export var ASYNC_VALIDATOR = Symbol('AsyncValidator');
/**
 * 判断一个校验函数是否是异步的，异步的校验函数必须使用 `createAsyncValidator` 创建
 * @param validator 校验函数
 */
export function isAsyncValidator(validator) {
    if (validator[ASYNC_VALIDATOR]) {
        return true;
    }
    return false;
}
/**
 * 创建一个异步校验函数
 * @param validator 异步校验函数的实现
 */
export function createAsyncValidator(validator) {
    var _a;
    return _a = {},
        _a[ASYNC_VALIDATOR] = true,
        _a.validator = validator,
        _a;
}
// prettier-ignore
export var ValidateOption;
(function (ValidateOption) {
    /**
     * 默认行为
     */
    ValidateOption[ValidateOption["Empty"] = 0] = "Empty";
    /**
     * 校验时包含异步校验
     */
    ValidateOption[ValidateOption["IncludeAsync"] = 2] = "IncludeAsync";
    /**
     * 校验时包含没有 `touch` 过的字段
     */
    ValidateOption[ValidateOption["IncludeUntouched"] = 4] = "IncludeUntouched";
    /**
     * 递归校验下层的 `Field`，适用于直接从 `FieldSet` 和 `FieldArray` 触发的校验
     */
    ValidateOption[ValidateOption["IncludeChildrenRecursively"] = 8] = "IncludeChildrenRecursively";
    /**
     * 不校验没有修改过的 `Field`
     */
    ValidateOption[ValidateOption["ExcludePristine"] = 16] = "ExcludePristine";
    ValidateOption[ValidateOption["Default"] = 0] = "Default";
})(ValidateOption || (ValidateOption = {}));
var ErrorSubscriber = /** @class */ (function () {
    function ErrorSubscriber(model) {
        this.model = model;
    }
    ErrorSubscriber.prototype.next = function (error) {
        this.model.error = error;
    };
    return ErrorSubscriber;
}());
export { ErrorSubscriber };
/**
 * 表单校验函数的上下文信息
 */
var ValidatorContext = /** @class */ (function () {
    function ValidatorContext(model) {
        this.model = model;
    }
    ValidatorContext.prototype.getSection = function () {
        return this.model.owner;
    };
    ValidatorContext.prototype.getSectionValue = function () {
        var names = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            names[_i] = arguments[_i];
        }
        if (!this.model.owner || !isFieldSetModel(this.model.owner)) {
            return null;
        }
        if (names.length === 0) {
            return this.model.owner.getRawValue();
        }
        var data = {};
        for (var i = 0; i < names.length; i += 1) {
            var name_1 = names[i];
            var model = this.model.owner.get(name_1);
            if (model) {
                data[name_1] = model.getRawValue();
            }
        }
        return data;
    };
    ValidatorContext.prototype.getFormValue = function () {
        return this.model.form && this.model.form.getRawValue();
    };
    return ValidatorContext;
}());
export { ValidatorContext };
function runValidator(validator, _a, value, ctx) {
    var reject = _a.reject;
    try {
        if (isAsyncValidator(validator)) {
            var ret = validator.validator(value, ctx);
            if (ret === null) {
                return of(null);
            }
            return from(ret);
        }
        else {
            return of(validator(value, ctx));
        }
    }
    catch (error) {
        reject(error);
        return empty();
    }
}
var ValidatorExecutor = /** @class */ (function () {
    function ValidatorExecutor(model) {
        this.model = model;
        this.ctx = new ValidatorContext(model);
    }
    ValidatorExecutor.prototype.call = function (validation) {
        var _this = this;
        var option = validation.option, reject = validation.reject, resolve = validation.resolve;
        if (!this.model.touched() && !(option & ValidateOption.IncludeUntouched)) {
            resolve();
            return of(null);
        }
        if (option & ValidateOption.ExcludePristine && this.model.pristine()) {
            resolve();
            return of(null);
        }
        var value = this.model.getRawValue();
        var skipAsync = (option & ValidateOption.IncludeAsync) === 0;
        return from(this.model.validators).pipe(filter(function (validator) { return (skipAsync ? !isAsyncValidator(validator) : true); }), map(function (validator) { return defer(function () { return runValidator(validator, validation, value, _this.ctx); }); }), concatAll(), takeWhile(function (it) { return it == null; }, true), catchError(function (error) {
            reject(error);
            return empty();
        }), finalizeWithLast(resolve, null));
    };
    return ValidatorExecutor;
}());
/**
 * 执行 `model` 上的校验规则对 `model` 校验
 * @param model 要校验的 model 对象
 */
export function validate(model) {
    var executor = new ValidatorExecutor(model);
    return function (validation) { return executor.call(validation); };
}
