import { __assign } from "tslib";
import * as React from 'react';
import { merge, never, of } from 'rxjs';
import { filter, switchMap } from 'rxjs/operators';
import { useFormContext, FormContext } from './context';
import { useValue$ } from './hooks';
import { isFieldSetModel, isFieldModel, isFieldArrayModel, isModelRef, } from './models';
import { noop } from './utils';
function getModelFromContext(ctx, name, model, check) {
    var parent = ctx.parent;
    var m = React.useMemo(function () {
        if (typeof name === 'string') {
            var m_1 = parent.get(name);
            if (check(m_1)) {
                return m_1;
            }
        }
        if (check(model)) {
            return model;
        }
        return null;
    }, [ctx, name, model, check, parent]);
    var _a = React.useState(m), maybeModel = _a[0], setModel = _a[1];
    React.useEffect(function () {
        if (!name) {
            return noop;
        }
        var m = parent.get(name);
        check(m) && setModel(m);
        var $ = merge(parent.childRegister$, parent.childRemove$)
            .pipe(filter(function (change) { return change === name; }))
            .subscribe(function (name) {
            var candidate = parent.get(name);
            if (check(candidate)) {
                setModel(candidate);
            }
        });
        return function () { return $.unsubscribe(); };
    }, [name, parent, m]);
    return maybeModel;
}
/**
 * 根据 `name` 订阅 `FieldSet` 的值
 */
export function FieldSetValue(_a) {
    var name = _a.name, children = _a.children;
    var ctx = useFormContext();
    var model = getModelFromContext(ctx, name, undefined, isFieldSetModel);
    var childContext = React.useMemo(function () { return (__assign(__assign({}, ctx), { parent: model })); }, [ctx, model]);
    if (model) {
        return (React.createElement(FormContext.Provider, { key: model.id, value: childContext }, children));
    }
    return null;
}
export function useFieldValue(field) {
    var ctx = useFormContext();
    var _a = React.useState(isFieldModel(field) || isModelRef(field) ? field : null), model = _a[0], setModel = _a[1];
    React.useEffect(function () {
        if (typeof field !== 'string') {
            setModel(isFieldModel(field) || isModelRef(field) ? field : null);
            return noop;
        }
        var m = ctx.parent.get(field);
        if (isFieldModel(m)) {
            setModel(m);
        }
        var $ = merge(ctx.parent.childRegister$, ctx.parent.childRemove$)
            .pipe(filter(function (change) { return change === field; }))
            .subscribe(function (name) {
            var candidate = ctx.parent.get(name);
            if (isFieldModel(candidate)) {
                setModel(candidate);
            }
        });
        return function () { return $.unsubscribe(); };
    }, [field, ctx.parent]);
    if (!model) {
        useValue$(never(), null);
        return null;
    }
    else if (isModelRef(model)) {
        var _b = React.useState(null), value = _b[0], setValue_1 = _b[1];
        React.useEffect(function () {
            var $ = model.model$
                .pipe(switchMap(function (it) {
                if (isFieldModel(it)) {
                    return it.value$;
                }
                return of(null);
            }))
                .subscribe(function (value) { return setValue_1(value); });
            return function () { return $.unsubscribe(); };
        }, [model]);
        return value;
    }
    return useValue$(model.value$, model.value);
}
/**
 * 根据 `name` 或者 `model` 订阅字段的更新
 */
export function FieldValue(props) {
    var _a = props, name = _a.name, model = _a.model, children = _a.children;
    var value = useFieldValue(model || name);
    if (value === null) {
        return null;
    }
    if (children) {
        return children(value);
    }
    return value;
}
/**
 * 根据 `name` 或者 `model` 订阅 `FieldArray` 的更新
 */
export function useFieldArrayValue(field) {
    var ctx = useFormContext();
    var model = getModelFromContext(ctx, field, field, isFieldArrayModel);
    if (!model) {
        useValue$(never(), null);
        return null;
    }
    var children = useValue$(model.children$, model.children);
    return children;
}
