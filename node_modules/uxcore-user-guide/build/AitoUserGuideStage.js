'use strict';

function _defaults(obj, defaults) { var keys = Object.getOwnPropertyNames(defaults); for (var i = 0; i < keys.length; i++) { var key = keys[i]; var value = Object.getOwnPropertyDescriptor(defaults, key); if (value && value.configurable && obj[key] === undefined) { Object.defineProperty(obj, key, value); } } return obj; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : _defaults(subClass, superClass); }

/*
 * @Author: tongbin.xtb
 * @Date: 2018-01-03 17:34:28
 * @Last Modified by: tongbin.xtb
 * @Last Modified time: 2018-02-24 19:32:32
 */

var React = require('react');
var PropTypes = require('prop-types');
var scrollToTop = require('./scrollToTop');

var texts = {
  'zh-cn': {
    done: '我知道了',
    next: '我知道了',
    skip: '跳过'
  },
  'en-us': {
    done: 'done',
    next: 'next',
    skip: 'skip'
  }
};

var LEFT_ARROW = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGYAAABKBAMAAAC7nzwcAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAtUExURUdwTNnZ2cPDw8vLy8PDw8PDw8PDw8TExMTExMXFxcPDw8XFxcTExMTExMLCwmBpOCIAAAAOdFJOUwAGxxLxlt5nfyWtNERVIw6LxwAAAepJREFUSMdjYCAfWCwmWYuE30tStYjnPdpAohbevEcHSNTCo/fsAolauPWeFZKohXPdk0YStTDHPWkmNci43gWTHDMcjxjYSfUOs98BkyeRJGrqU5DVe6crgFPefJEWhjvE3jJwh7xznYArJvzevXuGLsn+TICBuegdrpTAmFSzI88TXTSvAEhs9cOVFAwYGIQeoTv9XiI4mQrgCSewsciA6QWciStx3wtAT6JPDGCsZ8U40heGiF4DLE/4PVmD6iicDt7nDGPJrnuXgRyuHDk4k9xThCPa3r26iJAReY0zN7xDMvvUu8cITp0CzrCMQw4WcyTOugKceqww4nMvJCj9oA4QICbhrnvUA1TH+Qya5tKJ0VP07p1T+EaeR5BoW/fIgBhNMk3v3r2b/oqBYc/1IL93gUTmK5tSFQlgqsoDZgUSCgxGDqCeqKU9BqRkYfanpFcWvBkMo2BQg6Oka2HMu0C6JjyZGycQe05GintiQLomvQDS9Ux5S7oe9icTSNe0TpF0PWavSNfD6UFG8jEYfjmCW4B0PVuUSdez7dkGkvUw67mTbpEoGQ1DhpJnB0hPQXpPSQ87iXeJZIQdGRmWkY5plZGMfM7+lHQHsr7zIF3TLHI07cLdEMen6RXpmqa+ayA98KaSFbkAI9OEBJ8okNsAAAAASUVORK5CYII='; // eslint-disable-line

var RIGHT_ARROW = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGYAAABKBAMAAAC7nzwcAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAtUExURUdwTM7OzsfHx8PDw8TExMPDw8PDw8XFxcPDw8TExMPDw8TExMPDw8PDw8LCwqdnTr8AAAAOdFJOUwAMIN5r8ZQ0zEaBWbqn+68bwwAAAeRJREFUSMdjYKApkF1Iuh69p44k62E/99iBZE2cfY83kKyJ2+7FBJI1sdi9KSBZk1TcWwUyND0jXZPauwsk6hBxYDi3gERL4gI5nwqgh+aNXtyRzbjn3YsNHE/Qo9ru3bunuEKTKfVdWAHDPkM0YdXH7lOaBXClgnctQCk7tPTD2NcIJHAlgqfpoFh9jB7NjwXwBMBGECH8Gk2U7TWuJA1nrWtAl8MRxSJ9sKTJGIcrkTKiOnFu3FNYHuB6g8vlk5GjmmnxuzfwbKP6HJeeukCk4Dr3zgrh5DyciY0DKSz03t1EsvMdzkTN8hYpLJHTEtsznDHB9BQSFNMx0sIlTMXO0LRmB3QC46y+t0Qkdca+t5DgPzdB3K313bsjxOQPsXdPj3kDXXRv07t377omEpeptICZ4QUwhSyIuFJIdE5kmpV7FqiH9AKTIY8MPYtJL2NHAf1AJulaOPEWcziy9hPS7cEoxonIeXGkpzbeN2Q4LYhkLUxxpGceCTKcdo/0UGNYSnqbgYFpGGUCRtJbZwwa4aS3Uu3MSdbj+obkzCb7LoHkLG0XTXKY5b0gOdUIv1tAcgCwmZMRnwK0TzNkpH8m0utPxqUkRyZQyyVSHZb67jipafneu+skd4NIdhjQN0l0KQEA9YJ/Yn2MqJgAAAAASUVORK5CYII='; // eslint-disable-line

var AitoUserGuideStage = function (_React$Component) {
  _inherits(AitoUserGuideStage, _React$Component);

  function AitoUserGuideStage(props) {
    _classCallCheck(this, AitoUserGuideStage);

    var _this = _possibleConstructorReturn(this, _React$Component.call(this, props));

    _this.state = {
      currentStep: 0
    };
    return _this;
  }

  AitoUserGuideStage.prototype.componentDidMount = function componentDidMount() {
    var height = Math.max(window.innerHeight, window.document.body.clientHeight, window.document.body.scrollHeight);
    var cWidth = window.innerWidth;
    this.bgCanvas.height = height + 60;
    this.bgCanvas.width = cWidth;
    this.bgCanvas.style.height = this.bgCanvas.height + 'px';
    this.clearBg();
    this.highlightStep(this.props.steps[this.state.currentStep]);
    this.nextStep(-1);
  };

  AitoUserGuideStage.prototype.getDom = function getDom(s) {
    if (!s) {
      return null;
    }
    var dom = s.dom;
    if (s.type === 'HTMLElement' || s.type === 'HTMLElementMaker' || s.type === 'ReactComponent') {
      if (s.type === 'HTMLElementMaker') {
        if (typeof s.dom === 'function') {
          dom = s.dom();
        }
      }
      if (!(dom instanceof HTMLElement)) {
        return null;
      }
    }
    return dom;
  };

  AitoUserGuideStage.prototype.getCenter = function getCenter(s) {
    var center = {};
    if (s.type === 'HTMLElement' || s.type === 'HTMLElementMaker' || s.type === 'ReactComponent') {
      var dom = s.dom;
      if (s.type === 'HTMLElementMaker') {
        if (typeof s.dom === 'function') {
          dom = s.dom();
        }
      }
      if (!(dom instanceof HTMLElement)) {
        return {
          x: 0, y: 0, w: 0, h: 0
        };
      }

      var _dom$getBoundingClien = dom.getBoundingClientRect(),
          top = _dom$getBoundingClien.top,
          left = _dom$getBoundingClien.left,
          w = _dom$getBoundingClien.width,
          h = _dom$getBoundingClien.height;

      center = {
        x: left + w / 2,
        y: top + h / 2,
        w: s.imageWidth || w,
        h: s.imageHeight || h
      };
      center.y += window.scrollY;
    } else if (s.type === 'Image') {
      center = {
        x: s.left,
        y: s.top,
        w: s.imageWidth,
        h: s.imageHeight
      };
    }
    return center;
  };

  AitoUserGuideStage.prototype.clearBg = function clearBg() {
    var ctx = this.bgCanvas.getContext('2d');
    var height = this.bgCanvas.clientHeight;
    var width = this.bgCanvas.clientWidth;
    ctx.clearRect(0, 0, this.bgCanvas.clientWidth, this.bgCanvas.clientHeight);
    ctx.fillStyle = 'rgba(0,0,0,0.6)';
    ctx.fillRect(0, 0, width, height);
  };

  AitoUserGuideStage.prototype.highlightStep = function highlightStep(config) {
    this.clearBg();
    var dom = this.getDom(config);
    if (config && !config.image && dom) {
      // debugger;
      var _dom$getBoundingClien2 = dom.getBoundingClientRect(),
          l = _dom$getBoundingClien2.left,
          r = _dom$getBoundingClien2.right,
          top = _dom$getBoundingClien2.top,
          bottom = _dom$getBoundingClien2.bottom;

      var t = top;
      var b = bottom;
      t += window.scrollY;
      b += window.scrollY;
      var ctx = this.bgCanvas.getContext('2d');
      var rad = 4;
      ctx.save();
      ctx.strokeStyle = '0 none';
      ctx.beginPath();
      ctx.moveTo(l + rad, t);
      ctx.arcTo(r, t, r, b - rad, rad);
      ctx.arcTo(r, b, l + rad, b, rad);
      ctx.arcTo(l, b, l, t + rad, rad);
      ctx.arcTo(l, t, l + rad, t, rad);
      ctx.closePath();
      // ctx.stroke();
      ctx.clip();
      ctx.clearRect(0, 0, this.bgCanvas.clientWidth, this.bgCanvas.clientHeight);
      ctx.restore();
    }
  };

  AitoUserGuideStage.prototype.nextStep = function nextStep(index) {
    var _this2 = this;

    var center = { x: 0, y: 0 };
    if (this.props.steps[index + 1]) {
      center = this.getCenter(this.props.steps[index + 1]);
    }
    var to = void 0;
    var height = center.h;
    if (center.x - 319 - center.w / 2 < 0) {
      height += 200;
    }
    var _window = window,
        innerHeight = _window.innerHeight;

    if (innerHeight > height) {
      to = center.y - center.h / 2 - (innerHeight - height) / 2;
    } else {
      to = center.y - center.h / 2 + height - innerHeight;
    }
    if (to < 0) {
      to = 0;
    }
    scrollToTop(to);
    this.setState({
      currentStep: index + 1
    }, function () {
      _this2.highlightStep(_this2.props.steps[_this2.state.currentStep]);
      if (index >= _this2.props.steps.length - 1) {
        _this2.props.done();
      }
    });
  };

  AitoUserGuideStage.prototype.render = function render() {
    var _this3 = this;

    var _window2 = window,
        width = _window2.innerWidth;

    var last = this.props.steps.length - 1;
    return React.createElement(
      'div',
      null,
      React.createElement('canvas', {
        ref: function ref(_ref) {
          _this3.bgCanvas = _ref;
        },
        className: 'bg-canvas'
      }),
      this.props.steps.map(function (s, index) {
        var center = _this3.getCenter(s);
        var layout = 'right';
        var reverted = false;
        if (center.x + 319 + center.w / 2 > width) {
          layout = 'left';
          if (center.x - 319 - center.w / 2 < 0) {
            reverted = true;
          }
        }
        var hint = React.createElement(
          'div',
          {
            className: 'step-hint' + (reverted ? ' wrapped-line' : '')
          },
          React.createElement(
            'div',
            { className: 'step-hint-text' },
            React.createElement(
              'div',
              null,
              index + 1,
              ' / ',
              React.createElement(
                'span',
                { className: 'secondary-text' },
                last + 1
              )
            ),
            React.createElement(
              'div',
              null,
              s.hint
            )
          ),
          React.createElement(
            'div',
            { className: 'text-right' },
            React.createElement(
              'span',
              {
                role: 'button',
                className: 'skip-text',
                onClick: function onClick() {
                  return _this3.nextStep(_this3.props.steps.length - 1);
                }
              },
              texts[_this3.props.locale].skip
            ),
            React.createElement(
              'button',
              {
                className: 'kuma-button kuma-button-primary',
                onClick: function onClick() {
                  _this3.nextStep(index);
                }
              },
              index === last ? texts[_this3.props.locale].done : texts[_this3.props.locale].next
            )
          )
        );
        var imageWrp = React.createElement(
          'div',
          {
            className: 'img-wrp' + (reverted ? ' wrapped-line' : ''),
            style: { "float": layout === 'left' ? 'right' : 'left' }
          },
          React.createElement('img', { role: 'presentation', src: layout === 'left' && !reverted ? RIGHT_ARROW : LEFT_ARROW })
        );
        return React.createElement(
          'div',
          {
            key: s.step,
            className: 'layout-' + layout,
            style: {
              position: 'absolute',
              left: layout === 'left' ? 0 : center.x - center.w / 2,
              top: center.y - center.h / 2,
              display: index === _this3.state.currentStep ? 'block' : 'none',
              right: layout === 'left' ? width - (center.x + center.w / 2) : 0
            }
          },
          s.image ? React.createElement('img', {
            alt: s.hint,
            src: s.image,
            className: 'hint-img',
            style: {
              height: center.h,
              width: center.w
            }
          }) : React.createElement('div', {
            className: 'hint-img',
            style: {
              height: center.h,
              width: center.w
            }
          }),
          reverted ? hint : imageWrp,
          reverted ? imageWrp : hint
        );
      })
    );
  };

  return AitoUserGuideStage;
}(React.Component);

AitoUserGuideStage.defaultProps = {
  steps: [],
  done: function done() {},
  locale: 'zh-cn'
};

AitoUserGuideStage.propTypes = {
  steps: PropTypes.array,
  done: PropTypes.func,
  locale: PropTypes.string
};

AitoUserGuideStage.displayName = 'AitoUserGuideStage';

module.exports = AitoUserGuideStage;